<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.comma_groupware.mapper.EmployeeMapper">

	<!-- 조직도 리스트 -->
	<select id="organizationList" parameterType="com.example.comma_groupware.dto.Page" resultType="map">
		SELECT 
			e.emp_name AS empName,
			e.emp_email AS empEmail,
			r.rank_name AS rankName,
			d.dept_name AS deptName,
			t.team_name AS teamName
		FROM
		(
			SELECT * FROM employee
			WHERE emp_status = '재직'
			<if test="searchWord != null">
			AND emp_name LIKE CONCAT('%', #{searchWord}, '%')
			</if>
		) e
		INNER JOIN (SELECT * from department_history WHERE end_date IS NULL) dh ON e.emp_id = dh.emp_id
		INNER JOIN team t ON t.team_id = dh.team_id
		INNER JOIN department d ON d.dept_id = t.dept_id
		INNER JOIN rank_history rh ON e.emp_id = rh.emp_id
		INNER JOIN `rank` r ON r.rank_id = rh.rank_id;
	</select>

	<!-- 조직도 리스트 전체 데이터 카운트 -->
	<select id="organizationListCount" parameterType="String" resultType="Integer">
		SELECT 
			count(*) AS count
		FROM
		(
			SELECT * FROM employee
			WHERE emp_status = '재직'
			<if test="name != null">
				AND emp_name LIKE CONCAT('%', #{name}, '%')
			</if>
		) e
		INNER JOIN (SELECT * from department_history WHERE end_date IS NULL) dh ON e.emp_id = dh.emp_id
		INNER JOIN team t ON t.team_id = dh.team_id
		INNER JOIN department d ON d.dept_id = t.dept_id
		INNER JOIN (SELECT * from rank_history WHERE end_date IS NULL) rh ON e.emp_id = rh.emp_id
		INNER JOIN `rank` r ON r.rank_id = rh.rank_id;
	</select>
	
</mapper>